{
  "info": {
    "title": "SEDAI Solar2Grid API Contract",
    "version": "1.0.0",
    "description": "统一接口契约：POST用JSON body，GET用query参数"
  },
  "endpoints": {
    "forecast_run": {
      "method": "POST",
      "path": "/forecast/run",
      "description": "触发预测运行，生成光伏功率预测",
      "request": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "horizon": "day_ahead",
        "start": "2026-02-10T00:00:00Z",
        "end": "2026-02-11T00:00:00Z",
        "resolution_minutes": 15,
        "quantiles": [0.1, 0.5, 0.9],
        "weather_source": "telemetry_or_mock"
      },
      "response": {
        "run_id": "uuid",
        "status": "ok"
      }
    },
    "forecast_latest": {
      "method": "GET",
      "path": "/forecast/latest",
      "description": "获取最新的预测结果",
      "query_params": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "horizon": "day_ahead"
      },
      "response": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "horizon": "day_ahead",
        "resolution_minutes": 15,
        "unit": "kW",
        "points": [
          {
            "ts": "2026-02-10T00:00:00Z",
            "p10": 0.0,
            "p50": 0.0,
            "p90": 0.0
          }
        ]
      }
    },
    "dispatch_run": {
      "method": "POST",
      "path": "/dispatch/run",
      "description": "触发调度优化，生成能源管理调度计划",
      "request": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "start": "2026-02-10T00:00:00Z",
        "end": "2026-02-11T00:00:00Z",
        "resolution_minutes": 15,
        "forecast_quantile": 0.5,
        "load_kw": [
          50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 52.0, 55.0, 
          60.0, 65.0, 70.0, 75.0, 80.0, 85.0, 90.0, 95.0,
          100.0, 105.0, 110.0, 115.0, 120.0, 125.0, 130.0, 135.0,
          140.0, 145.0, 150.0, 155.0, 160.0, 165.0, 170.0, 175.0,
          180.0, 185.0, 190.0, 195.0, 200.0, 195.0, 190.0, 185.0,
          180.0, 175.0, 170.0, 165.0, 160.0, 155.0, 150.0, 145.0,
          140.0, 135.0, 130.0, 125.0, 120.0, 115.0, 110.0, 105.0,
          100.0, 95.0, 90.0, 85.0, 80.0, 75.0, 70.0, 65.0,
          60.0, 58.0, 56.0, 54.0, 52.0, 50.0, 50.0, 50.0,
          50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0,
          50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0,
          50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0
        ],
        "tariff": {
          "buy": [
            0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.12, 0.15,
            0.18, 0.20, 0.22, 0.25, 0.28, 0.30, 0.32, 0.35,
            0.38, 0.40, 0.42, 0.45, 0.48, 0.50, 0.52, 0.55,
            0.58, 0.60, 0.62, 0.65, 0.68, 0.70, 0.72, 0.75,
            0.78, 0.80, 0.78, 0.75, 0.72, 0.70, 0.68, 0.65,
            0.62, 0.60, 0.58, 0.55, 0.52, 0.50, 0.48, 0.45,
            0.42, 0.40, 0.38, 0.35, 0.32, 0.30, 0.28, 0.25,
            0.22, 0.20, 0.18, 0.15, 0.12, 0.10, 0.10, 0.10,
            0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
            0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
            0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
            0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10
          ],
          "sell": [
            0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.06, 0.07,
            0.08, 0.09, 0.10, 0.11, 0.12, 0.13, 0.14, 0.15,
            0.16, 0.17, 0.18, 0.19, 0.20, 0.21, 0.22, 0.23,
            0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.30, 0.31,
            0.32, 0.33, 0.32, 0.31, 0.30, 0.29, 0.28, 0.27,
            0.26, 0.25, 0.24, 0.23, 0.22, 0.21, 0.20, 0.19,
            0.18, 0.17, 0.16, 0.15, 0.14, 0.13, 0.12, 0.11,
            0.10, 0.09, 0.08, 0.07, 0.06, 0.05, 0.05, 0.05,
            0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
            0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
            0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
            0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05
          ]
        },
        "bess": {
          "capacity_kwh": 100.0,
          "p_charge_max_kw": 50.0,
          "p_discharge_max_kw": 50.0,
          "soc0": 0.5,
          "soc_min": 0.2,
          "soc_max": 0.9,
          "eta_charge": 0.95,
          "eta_discharge": 0.95
        },
        "limits": {
          "grid_import_max_kw": 200.0,
          "grid_export_max_kw": 200.0,
          "transformer_max_kw": 250.0
        },
        "weights": {
          "cost": 1.0,
          "curtail": 0.2,
          "carbon": 0.0,
          "violation": 1000.0
        }
      },
      "response": {
        "run_id": "uuid",
        "status": "ok",
        "fallback_used": false
      }
    },
    "dispatch_latest": {
      "method": "GET",
      "path": "/dispatch/latest",
      "description": "获取最新的调度结果",
      "query_params": {
        "site_id": "11111111-1111-1111-1111-111111111111"
      },
      "response": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "resolution_minutes": 15,
        "unit": "kW",
        "soc_unit": "fraction",
        "points": [
          {
            "ts": "2026-02-10T00:00:00Z",
            "pv_set_kw": 0.0,
            "batt_ch_kw": 0.0,
            "batt_dis_kw": 0.0,
            "grid_imp_kw": 50.0,
            "grid_exp_kw": 0.0,
            "curtail_kw": 0.0,
            "soc": 0.5,
            "reason": "Grid import to meet demand"
          }
        ]
      }
    },
    "validate_run": {
      "method": "POST",
      "path": "/validate/run",
      "description": "运行模型验证，计算预测误差指标",
      "request": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "horizon": "day_ahead",
        "metric": "pv_power_kw",
        "start": "2026-02-09T00:00:00Z",
        "end": "2026-02-09T23:59:59Z",
        "resolution_minutes": 15
      },
      "response": {
        "status": "ok",
        "validation_id": "uuid",
        "mae": 8.16,
        "nrmse": 0.227,
        "bias": -3.0,
        "points": 96
      }
    },
    "validate_latest": {
      "method": "GET",
      "path": "/validate/latest",
      "description": "获取最新的验证结果",
      "query_params": {
        "site_id": "11111111-1111-1111-1111-111111111111",
        "horizon": "day_ahead",
        "metric": "pv_power_kw"
      },
      "response": {
        "validation_id": "uuid",
        "site_id": "11111111-1111-1111-1111-111111111111",
        "horizon": "day_ahead",
        "metric": "pv_power_kw",
        "mae": 8.16,
        "nrmse": 0.227,
        "bias": -3.0,
        "start_ts": "2026-02-09T00:00:00Z",
        "end_ts": "2026-02-09T23:59:59Z",
        "created_at": "2026-02-09T12:00:00Z"
      }
    },
    "calibration_apply_latest": {
      "method": "POST",
      "path": "/calibration/apply_latest",
      "description": "基于最新验证结果应用模型校准",
      "request": {
        "site_id": "11111111-1111-1111-1111-111111111111"
      },
      "response": {
        "status": "ok",
        "calibration_id": "uuid",
        "bias": -3.0,
        "pr_old": 0.85,
        "pr_new": 0.843,
        "soiling": 0.98
      }
    }
  },
  "notes": {
    "conventions": [
      "所有 POST 端点使用 JSON body 传参",
      "所有 GET 端点使用 query 参数传参",
      "时间戳统一使用 ISO 8601 格式 (YYYY-MM-DDTHH:MM:SSZ)",
      "UUID 使用标准 36 字符格式",
      "所有数组长度必须与时间范围和分辨率一致 (96个点 = 24小时 * 4个点/小时)"
    ],
    "mock_data": [
      "load_kw: 目前可以前端传入mock值，后续从 DB 查询 load_forecasts 表",
      "tariff: 目前可以前端传入mock值，后续从 DB 查询 tariff_profiles 表",
      "weather_source: 目前支持 'telemetry_or_mock'，后续可扩展为 'external_api'"
    ]
  }
}
